<script>
  let currentSection = 'welcome';
  let currentData = {};
  let isLoading = false; // Anti-spam
  
  function showCalendar() {
    if (isLoading) return;
    
    currentSection = 'calendar';
    isLoading = true;
    
    document.getElementById('content').innerHTML = `
      <div class="section active">
        <h2>ğŸ“… Calendrier des SoirÃ©es</h2>
        <div class="loading-container">
          <img src="https://cataas.com/cat/gif/says/Loading...?filter=mono&fontColor=orange&fontSize=20&type=square" 
               alt="Loading cat" class="loading-cat" />
          <p>Chargement en cours...</p>
        </div>
      </div>
    `;
    
    const startTime = Date.now();
    google.script.run
      .withSuccessHandler(events => {
        const loadTime = Date.now() - startTime;
        console.log(`Chargement Ã©vÃ©nements: ${loadTime}ms`);
        isLoading = false;
        displayEvents(events);
      })
      .withFailureHandler(err => {
        console.error('Erreur:', err);
        isLoading = false;
        document.getElementById('content').innerHTML = `
          <div class="section active">
            <h2>ğŸ“… Calendrier des SoirÃ©es</h2>
            <p>âŒ Erreur de chargement</p>
            <button class="add-btn" onclick="showCalendar()">ğŸ”„ RÃ©essayer</button>
          </div>
        `;
      })
      .getAllEvents();
  }
  
  function displayEvents(events) {
    if (!events || !Array.isArray(events)) {
      events = [];
    }
    
    currentData.events = events;
    let eventsHtml = '';
    
    events.forEach(event => {
      const votes = event.votes || {};
      const yesVotes = votes.yes || 0;
      const noVotes = votes.no || 0;
      const maybeVotes = votes.maybe || 0;
      
      // Fix date J-1
      let displayDate = 'Date non dÃ©finie';
      try {
        if (event.date) {
          if (typeof event.date === 'string' && event.date.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const dateParts = event.date.split('-');
            const eventDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
            displayDate = eventDate.toLocaleDateString('fr-FR', {
              weekday: 'long',
              year: 'numeric', 
              month: 'long',
              day: 'numeric'
            });
          } else {
            const eventDate = new Date(event.date);
            if (!isNaN(eventDate.getTime())) {
              displayDate = eventDate.toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric', 
                month: 'long',
                day: 'numeric'
              });
            } else {
              displayDate = event.date;
            }
          }
        }
      } catch (e) {
        displayDate = event.date;
      }
      
      eventsHtml += `
        <div class="vote-item">
          <h3>${event.title}</h3>
          <p>ğŸ“… ${displayDate} â€¢ ProposÃ© par ${event.author}</p>
          <p>${event.description}</p>
          
          <div class="vote-buttons">
            <button class="vote-btn yes" onclick="vote('event', '${event.id}', 'yes')" data-event="${event.id}">
              ğŸ‘ Oui (${yesVotes})
            </button>
            <button class="vote-btn no" onclick="vote('event', '${event.id}', 'no')" data-event="${event.id}">
              ğŸ‘ Non (${noVotes})
            </button>
            <button class="vote-btn maybe" onclick="vote('event', '${event.id}', 'maybe')" data-event="${event.id}">
              ğŸ¤” Peut-Ãªtre (${maybeVotes})
            </button>
          </div>
          
          <div class="event-meta">
            <button class="meta-btn participants-btn" onclick="toggleParticipants('${event.id}')">
              ğŸ‘¥ Participants (${yesVotes + noVotes + maybeVotes})
            </button>
            <button class="meta-btn delete-btn" onclick="deleteEvent('${event.id}')">
              ğŸ—‘ï¸ Supprimer
            </button>
          </div>
          
          <!-- Zone participants cachÃ©e par dÃ©faut -->
          <div id="participants-${event.id}" class="participants-zone" style="display: none;">
            <div class="participants-loading">
              <img src="https://cataas.com/cat/gif/says/Loading?filter=mono&fontColor=blue&fontSize=14&type=square" 
                   alt="Loading participants" class="loading-cat-small" />
              <p>Chargement des participants...</p>
            </div>
          </div>
        </div>
      `;
    });
    
    document.getElementById('content').innerHTML = `
      <div class="section active">
        <h2>ğŸ“… Calendrier des SoirÃ©es</h2>
        <p>Organise et vote pour les prochaines soirÃ©es !</p>
        <button class="add-btn" onclick="addEvent()">+ Organiser une soirÃ©e</button>
        <div id="events-list">
          ${eventsHtml || '<p>Aucun Ã©vÃ©nement pour le moment. Organise la premiÃ¨re soirÃ©e !</p>'}
        </div>
      </div>
    `;
  }
  
  function toggleParticipants(eventId) {
    const zone = document.getElementById('participants-' + eventId);
    const btn = document.querySelector(`[onclick="toggleParticipants('${eventId}')"]`);
    
    if (!zone) return;
    
    if (zone.style.display === 'none') {
      // Ouvrir et charger
      zone.style.display = 'block';
      btn.textContent = 'ğŸ‘† Masquer participants';
      loadParticipants(eventId);
    } else {
      // Fermer
      zone.style.display = 'none';
      const event = currentData.events.find(e => e.id === eventId);
      if (event) {
        const votes = event.votes || {};
        const total = (votes.yes || 0) + (votes.no || 0) + (votes.maybe || 0);
        btn.textContent = `ğŸ‘¥ Participants (${total})`;
      }
    }
  } 
  function loadParticipants(eventId) {
    google.script.run
      .withSuccessHandler(participants => {
        displayParticipantsInZone(eventId, participants);
      })
      .withFailureHandler(err => {
        console.error('âŒ Erreur loadParticipants:', err);
        const zone = document.getElementById('participants-' + eventId);
        if (zone) {
          zone.innerHTML = `<p class="error">âŒ Erreur chargement participants</p>`;
        }
      })
      .getEventParticipants(eventId);
  }

  function displayParticipantsInZone(eventId, participants) {
    const zone = document.getElementById('participants-' + eventId);
    if (!zone) {
      return;
    }
    
    // Protection
    if (!participants || !Array.isArray(participants)) {
      participants = [];
    }
    
    const event = currentData.events.find(e => e.id === eventId);
    if (!event) {
      return;
    }
    
    const yesParticipants = participants.filter(p => p && p.vote === 'yes');
    const noParticipants = participants.filter(p => p && p.vote === 'no');
    const maybeParticipants = participants.filter(p => p && p.vote === 'maybe');
    
    let participantsHtml = `
      <div class="participants-content">
        <div class="participants-group">
          <h5>âœ… Participants confirmÃ©s (${yesParticipants.length})</h5>
          ${yesParticipants.map(p => `<div class="participant yes">${p.email}</div>`).join('') || '<p>Aucun participant confirmÃ©</p>'}
        </div>
        
        <div class="participants-group">
          <h5>ğŸ¤” Peut-Ãªtre (${maybeParticipants.length})</h5>
          ${maybeParticipants.map(p => `<div class="participant maybe">${p.email}</div>`).join('') || '<p>Aucun "peut-Ãªtre"</p>'}
        </div>
        
        <div class="participants-group">
          <h5>âŒ Ne viennent pas (${noParticipants.length})</h5>
          ${noParticipants.map(p => `<div class="participant no">${p.email}</div>`).join('') || '<p>Personne n\'a dit non</p>'}
        </div>
      </div>
    `;
    
    zone.innerHTML = participantsHtml;
  }
  
  function vote(itemType, itemId, voteType) {
    if (isLoading) return;
    
    const button = event.target;
    const originalText = button.textContent;
    
    const eventButtons = document.querySelectorAll(`[data-event="${itemId}"]`);
    eventButtons.forEach(btn => btn.disabled = true);
    
    button.textContent = 'â³';
    isLoading = true;
    
    google.script.run
      .withSuccessHandler(() => {
        button.textContent = 'âœ…';
        isLoading = false;
        setTimeout(() => {
          switch(currentSection) {
            case 'calendar': showCalendar(); break;
            case 'bars': showBars(); break;
            case 'karaoke': showKaraoke(); break;
            case 'activities': showActivities(); break;
          }
        }, 500);
      })
      .withFailureHandler(err => {
        button.textContent = 'âŒ';
        isLoading = false;
        eventButtons.forEach(btn => btn.disabled = false);
        setTimeout(() => {
          button.textContent = originalText;
        }, 2000);
        alert('Erreur lors du vote: ' + err);
      })
      .recordVote(itemType, itemId, voteType);
  }
  
  function deleteEvent(eventId) {
    if (isLoading) return;
    
    if (!confirm('ÃŠtes-vous sÃ»r de vouloir supprimer cet Ã©vÃ©nement ?')) {
      return;
    }
    
    isLoading = true;
    
    google.script.run
      .withSuccessHandler(response => {
        isLoading = false;
        if (response.success) {
          alert('Ã‰vÃ©nement supprimÃ© avec succÃ¨s !');
          showCalendar();
        }
      })
      .withFailureHandler(err => {
        isLoading = false;
        alert('Erreur suppression: ' + err);
      })
      .deleteEvent(eventId);
  }
  
  // ... garder toutes les autres fonctions (showBars, showKaraoke, etc.) identiques
  
  function showBars() {
    if (isLoading) return;
    
    currentSection = 'bars';
    isLoading = true;
    
    document.getElementById('content').innerHTML = `
      <div class="section active">
        <h2>ğŸ» Meilleurs Bars</h2>
        <div class="loading-container">
          <img src="https://cataas.com/cat/gif/says/Bars?filter=mono&fontColor=yellow&fontSize=20&type=square" 
               alt="Loading bars" class="loading-cat" />
          <p>Chargement en cours...</p>
        </div>
      </div>
    `;
    
    const startTime = Date.now();
    google.script.run
      .withSuccessHandler(bars => {
        const loadTime = Date.now() - startTime;
        console.log(`Chargement bars: ${loadTime}ms`);
        isLoading = false;
        displayBars(bars);
      })
      .withFailureHandler(err => {
        console.error('Erreur:', err);
        isLoading = false;
        document.getElementById('content').innerHTML = `
          <div class="section active">
            <h2>ğŸ» Meilleurs Bars</h2>
            <p>âŒ Erreur de chargement</p>
            <button class="add-btn" onclick="showBars()">ğŸ”„ RÃ©essayer</button>
          </div>
        `;
      })
      .getAllBars();
  }
  
  function displayBars(bars) {
    if (!bars || !Array.isArray(bars)) {
      bars = [];
    }
    
    currentData.bars = bars;
    let barsHtml = '';
    
    bars.forEach(bar => {
      const votes = bar.votes || {};
      const upVotes = votes.up || 0;
      const downVotes = votes.down || 0;
      
      barsHtml += `
        <div class="vote-item">
          <h3>${bar.name}</h3>
          <p>ğŸ“ ${bar.location}</p>
          <p>${bar.description}</p>
          <div class="vote-buttons">
            <button class="vote-btn" onclick="vote('bar', '${bar.id}', 'up')">ğŸ‘ (${upVotes})</button>
            <button class="vote-btn" onclick="vote('bar', '${bar.id}', 'down')">ğŸ‘ (${downVotes})</button>
          </div>
        </div>
      `;
    });
    
    document.getElementById('content').innerHTML = `
      <div class="section active">
        <h2>ğŸ» Meilleurs Bars</h2>
        <p>DÃ©couvre et vote pour les meilleurs bars de la ville !</p>
        <button class="add-btn" onclick="addBar()">+ Ajouter un bar</button>
        <div id="bars-list">
          ${barsHtml || '<p>Aucun bar ajoutÃ©. Sois le premier Ã  recommander un spot !</p>'}
        </div>
      </div>
    `;
  }
  
  function showKaraoke() {
    if (isLoading) return;
    
    currentSection = 'karaoke';
    isLoading = true;
    
    document.getElementById('content').innerHTML = `
      <div class="section active">
        <h2>ğŸ¤ Meilleurs KaraokÃ©</h2>
        <div class="loading-container">
          <img src="https://cataas.com/cat/gif/says/Karaoke?filter=mono&fontColor=pink&fontSize=18&type=square" 
               alt="Loading karaoke" class="loading-cat" />
          <p>Chargement en cours...</p>
        </div>
      </div>
    `;
    
    const startTime = Date.now();
    google.script.run
      .withSuccessHandler(karaokes => {
        const loadTime = Date.now() - startTime;
        console.log(`Chargement karaokÃ©s: ${loadTime}ms`);
        isLoading = false;
        displayKaraoke(karaokes);
      })
      .withFailureHandler(err => {
        console.error('Erreur:', err);
        isLoading = false;
        document.getElementById('content').innerHTML = `
          <div class="section active">
            <h2>ğŸ¤ Meilleurs KaraokÃ©</h2>
            <p>âŒ Erreur de chargement</p>
            <button class="add-btn" onclick="showKaraoke()">ğŸ”„ RÃ©essayer</button>
          </div>
        `;
      })
      .getAllKaraoke();
  }
  
  function displayKaraoke(karaokes) {
    if (!karaokes || !Array.isArray(karaokes)) {
      karaokes = [];
    }
    
    currentData.karaokes = karaokes;
    let karaokeHtml = '';
    
    karaokes.forEach(karaoke => {
      const votes = karaoke.votes || {};
      const upVotes = votes.up || 0;
      const downVotes = votes.down || 0;
      
      karaokeHtml += `
        <div class="vote-item">
          <h3>${karaoke.name}</h3>
          <p>ğŸ“ ${karaoke.location}</p>
          <p>${karaoke.description}</p>
          <div class="vote-buttons">
            <button class="vote-btn" onclick="vote('karaoke', '${karaoke.id}', 'up')">ğŸ‘ (${upVotes})</button>
            <button class="vote-btn" onclick="vote('karaoke', '${karaoke.id}', 'down')">ğŸ‘ (${downVotes})</button>
          </div>
        </div>
      `;
    });
    
    document.getElementById('content').innerHTML = `
      <div class="section active">
        <h2>ğŸ¤ Meilleurs KaraokÃ©</h2>
        <p>Les spots karaokÃ© les plus hot de la ville ! ğŸ”¥</p>
        <button class="add-btn" onclick="addKaraoke()">+ Ajouter un karaokÃ©</button>
        <div id="karaoke-list">
          ${karaokeHtml || '<p>Aucun karaokÃ© ajoutÃ©. Partage tes spots prÃ©fÃ©rÃ©s !</p>'}
        </div>
      </div>
    `;
  }
  
  function showActivities() {
    if (isLoading) return;
    
    currentSection = 'activities';
    isLoading = true;
    
    document.getElementById('content').innerHTML = `
      <div class="section active">
        <h2>ğŸ¯ ActivitÃ©s Afterwork</h2>
        <div class="loading-container">
          <img src="https://cataas.com/cat/gif/says/Activities?filter=mono&fontColor=green&fontSize=16&type=square" 
               alt="Loading activities" class="loading-cat" />
          <p>Chargement en cours...</p>
        </div>
      </div>
    `;
    
    const startTime = Date.now();
    google.script.run
      .withSuccessHandler(activities => {
        const loadTime = Date.now() - startTime;
        console.log(`Chargement activitÃ©s: ${loadTime}ms`);
        isLoading = false;
        displayActivities(activities);
      })
      .withFailureHandler(err => {
        console.error('Erreur:', err);
        isLoading = false;
        document.getElementById('content').innerHTML = `
          <div class="section active">
            <h2>ğŸ¯ ActivitÃ©s Afterwork</h2>
            <p>âŒ Erreur de chargement</p>
            <button class="add-btn" onclick="showActivities()">ğŸ”„ RÃ©essayer</button>
          </div>
        `;
      })
      .getAllActivities();
  }
  
  function displayActivities(activities) {
    if (!activities || !Array.isArray(activities)) {
      activities = [];
    }
    
    currentData.activities = activities;
    let activitiesHtml = '';
    
    activities.forEach(activity => {
      const votes = activity.votes || {};
      const upVotes = votes.up || 0;
      const downVotes = votes.down || 0;
      
      activitiesHtml += `
        <div class="vote-item">
          <h3>${activity.name}</h3>
          <p>ğŸ“ ${activity.location} â€¢ â±ï¸ ${activity.duration} â€¢ ğŸ‘¥ ${activity.maxPlayers} joueurs max</p>
          <div class="vote-buttons">
            <button class="vote-btn" onclick="vote('activity', '${activity.id}', 'up')">ğŸ‘ (${upVotes})</button>
            <button class="vote-btn" onclick="vote('activity', '${activity.id}', 'down')">ğŸ‘ (${downVotes})</button>
          </div>
        </div>
      `;
    });
    
    document.getElementById('content').innerHTML = `
      <div class="section active">
        <h2>ğŸ¯ ActivitÃ©s Afterwork</h2>
        <p>Prison break, escape games et toutes les activitÃ©s fun !</p>
        <button class="add-btn" onclick="addActivity()">+ Ajouter une activitÃ©</button>
        <div id="activities-list">
          ${activitiesHtml || '<p>Aucune activitÃ© ajoutÃ©e. Propose tes activitÃ©s favorites !</p>'}
        </div>
      </div>
    `;
  }
  
  function addEvent() {
    if (isLoading) return;
    
    const eventForm = `
      <div class="form-container">
        <h3>Organiser une nouvelle soirÃ©e</h3>
        <input type="text" id="eventTitle" placeholder="Titre de la soirÃ©e" required />
        <input type="date" id="eventDate" required />
        <textarea id="eventDesc" placeholder="Description de la soirÃ©e..." rows="4"></textarea>
        <div class="form-buttons">
          <button class="add-btn" onclick="saveEvent()">CrÃ©er l'Ã©vÃ©nement</button>
          <button class="cancel-btn" onclick="showCalendar()">Annuler</button>
        </div>
      </div>
    `;
    document.getElementById('content').innerHTML = eventForm;
  }
  
  function saveEvent() {
    const title = document.getElementById('eventTitle').value;
    const date = document.getElementById('eventDate').value;
    const desc = document.getElementById('eventDesc').value;
    
    if (!title || !date) {
      alert('Veuillez remplir au moins le titre et la date');
      return;
    }
    
    if (isLoading) return;
    
    const saveBtn = document.querySelector('.add-btn');
    saveBtn.textContent = 'â³ CrÃ©ation...';
    saveBtn.disabled = true;
    isLoading = true;
    
    google.script.run
      .withSuccessHandler(() => {
        isLoading = false;
        alert('Ã‰vÃ©nement crÃ©Ã© avec succÃ¨s !');
        showCalendar();
      })
      .withFailureHandler(err => {
        isLoading = false;
        alert('Erreur: ' + err);
        saveBtn.textContent = 'CrÃ©er l\'Ã©vÃ©nement';
        saveBtn.disabled = false;
      })
      .createEvent(title, date, desc);
  }
  
  function addBar() {
    if (isLoading) return;
    
    const barForm = `
      <div class="form-container">
        <h3>Ajouter un nouveau bar</h3>
        <input type="text" id="barName" placeholder="Nom du bar" required />
        <input type="text" id="barLocation" placeholder="Adresse/Quartier" required />
        <textarea id="barDesc" placeholder="Description, ambiance, spÃ©cialitÃ©s..." rows="4"></textarea>
        <div class="form-buttons">
          <button class="add-btn" onclick="saveBar()">Ajouter le bar</button>
          <button class="cancel-btn" onclick="showBars()">Annuler</button>
        </div>
      </div>
    `;
    document.getElementById('content').innerHTML = barForm;
  }
  
  function saveBar() {
    const name = document.getElementById('barName').value;
    const location = document.getElementById('barLocation').value;
    const desc = document.getElementById('barDesc').value;
    
    if (!name || !location) {
      alert('Veuillez remplir au moins le nom et l\'adresse');
      return;
    }
    
    if (isLoading) return;
    
    const saveBtn = document.querySelector('.add-btn');
    saveBtn.textContent = 'â³ Ajout...';
    saveBtn.disabled = true;
    isLoading = true;
    
    google.script.run
      .withSuccessHandler(() => {
        isLoading = false;
        alert('Bar ajoutÃ© avec succÃ¨s !');
        showBars();
      })
      .withFailureHandler(err => {
        isLoading = false;
        alert('Erreur: ' + err);
        saveBtn.textContent = 'Ajouter le bar';
        saveBtn.disabled = false;
      })
      .addBar(name, location, desc);
  }
  
  function addKaraoke() {
    if (isLoading) return;
    
    const karaokeForm = `
      <div class="form-container">
        <h3>Ajouter un nouveau karaokÃ©</h3>
        <input type="text" id="karaokeName" placeholder="Nom du karaokÃ©" required />
        <input type="text" id="karaokeLocation" placeholder="Adresse/Quartier" required />
        <textarea id="karaokeDesc" placeholder="Type de salle, Ã©quipements, ambiance..." rows="4"></textarea>
        <div class="form-buttons">
          <button class="add-btn" onclick="saveKaraoke()">Ajouter le karaokÃ©</button>
          <button class="cancel-btn" onclick="showKaraoke()">Annuler</button>
        </div>
      </div>
    `;
    document.getElementById('content').innerHTML = karaokeForm;
  }
  
  function saveKaraoke() {
    const name = document.getElementById('karaokeName').value;
    const location = document.getElementById('karaokeLocation').value;
    const desc = document.getElementById('karaokeDesc').value;
    
    if (!name || !location) {
      alert('Veuillez remplir au moins le nom et l\'adresse');
      return;
    }
    
    if (isLoading) return;
    
    const saveBtn = document.querySelector('.add-btn');
    saveBtn.textContent = 'â³ Ajout...';
    saveBtn.disabled = true;
    isLoading = true;
    
    google.script.run
      .withSuccessHandler(() => {
        isLoading = false;
        alert('KaraokÃ© ajoutÃ© avec succÃ¨s !');
        showKaraoke();
      })
      .withFailureHandler(err => {
        isLoading = false;
        alert('Erreur: ' + err);
        saveBtn.textContent = 'Ajouter le karaokÃ©';
        saveBtn.disabled = false;
      })
      .addKaraoke(name, location, desc);
  }
  
  function addActivity() {
    if (isLoading) return;
    
    const activityForm = `
      <div class="form-container">
        <h3>Ajouter une nouvelle activitÃ©</h3>
        <input type="text" id="activityName" placeholder="Nom de l'activitÃ©" required />
        <input type="text" id="activityLocation" placeholder="Adresse/Quartier" required />
        <input type="text" id="activityDuration" placeholder="DurÃ©e (ex: 60 min)" />
        <input type="number" id="activityMaxPlayers" placeholder="Nombre max de joueurs" min="1" />
        <div class="form-buttons">
          <button class="add-btn" onclick="saveActivity()">Ajouter l'activitÃ©</button>
          <button class="cancel-btn" onclick="showActivities()">Annuler</button>
        </div>
      </div>
    `;
    document.getElementById('content').innerHTML = activityForm;
  }
  
  function saveActivity() {
    const name = document.getElementById('activityName').value;
    const location = document.getElementById('activityLocation').value;
    const duration = document.getElementById('activityDuration').value || 'Non spÃ©cifiÃ©';
    const maxPlayers = document.getElementById('activityMaxPlayers').value || 'IllimitÃ©';
    
    if (!name || !location) {
      alert('Veuillez remplir au moins le nom et l\'adresse');
      return;
    }
    
    if (isLoading) return;
    
    const saveBtn = document.querySelector('.add-btn');
    saveBtn.textContent = 'â³ Ajout...';
    saveBtn.disabled = true;
    isLoading = true;
    
    google.script.run
      .withSuccessHandler(() => {
        isLoading = false;
        alert('ActivitÃ© ajoutÃ©e avec succÃ¨s !');
        showActivities();
      })
      .withFailureHandler(err => {
        isLoading = false;
        alert('Erreur: ' + err);
        saveBtn.textContent = 'Ajouter l\'activitÃ©';
        saveBtn.disabled = false;
      })
      .addActivity(name, location, duration, maxPlayers);
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Event Organizer App initialized with cats! ğŸ±');
  });
  </script>